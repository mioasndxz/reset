<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AR Ï†ïÎ¶¨ ÎèÑÏö∞ÎØ∏ (YOLOv8)</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* CSS Î∂ÄÎ∂ÑÏùÄ Î≥ÄÍ≤Ω ÏóÜÏù¥ Í∑∏ÎåÄÎ°ú Îë°ÎãàÎã§. */
        :root {
            --padding-base: 16px;
            --button-height: 48px;
        }

        body {
            font-family: 'Noto Sans KR', sans-serif;
            margin: 0;
            padding: 0;
            background: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-text-size-adjust: 100%;
            font-size: 16px;
        }

        .screen {
            display: none;
            width: 100%;
            max-width: 640px;
            margin: 0 auto;
            box-sizing: border-box;
            padding: 0 var(--padding-base);
            flex-grow: 1;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .screen.active {
            display: flex;
        }

        #loadingScreen, #cameraScreen {
            padding-top: 50px;
        }

        #loadingScreen p {
            font-size: 1.2em;
            font-weight: bold;
            color: #00796b;
            text-align: center;
        }

        #video-container {
            position: relative;
            width: 100%;
            padding-top: 75%;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 20px;
        }
        #video, #liveCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #liveCanvas {
            z-index: 10;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            width: 100%;
            gap: 10px;
            margin-top: 10px;
        }
        button {
            padding: 14px 20px;
            font-size: 1.1em;
            font-weight: 700;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease, transform 0.2s ease;
            width: 100%;
            box-sizing: border-box;
        }
        button:hover {
            background: #357ABD;
            transform: translateY(-2px);
        }
        button:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 100;
            justify-content: center;
            align-items: center;
            padding: 10px;
            box-sizing: border-box;
        }
        .modal-content {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            width: 95%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
        }
        .modal-close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            color: #888;
            padding: 5px;
        }
        .modal-close-btn:hover {
            color: #555;
        }

        h3 {
            color: #2c3e50;
            margin-top: 0;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
            font-size: 1.2em;
        }
        ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }
        li {
            margin: 8px 0;
            display: flex;
            align-items: flex-start;
            font-size: 0.95em;
            line-height: 1.4;
        }
        input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.4);
            accent-color: #4a90e2;
            flex-shrink: 0;
            margin-top: 2px;
        }
        .message-box {
            text-align: center;
            font-weight: bold;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .error { 
            color: #d32f2f; 
            font-weight: bold; 
            text-align: center; 
            margin-top: 15px; 
            padding: 10px; 
            background-color: #ffebee; 
            border-radius: 8px; 
            font-size: 0.9em;
        }
        .scoreBox, .tipsBox, .spaceBox {
            font-weight: bold;
            color: #2c3e50;
            font-size: 1.1em;
            line-height: 1.5;
            background: #f8f8f8;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .scoreBox { color: #28a745; font-size: 1.3em; background: #e6ffe6; }
        .tipsBox { color: #007bff; background: #e8f5ff; }
        .spaceBox { color: #6f42c1; background: #f3e6ff; }

        .modal-img-container {
            width: 100%;
            position: relative;
            padding-top: 75%;
            background: #000;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 15px;
        }
        #modalCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        @media (max-width: 600px) {
            body {
                font-size: 15px;
            }
            .screen {
                padding: 0 10px;
            }
            button {
                padding: 12px 15px;
                font-size: 1em;
            }
            .modal-content {
                padding: 15px;
            }
            h3 {
                font-size: 1.1em;
            }
            li {
                font-size: 0.9em;
            }
            input[type="checkbox"] {
                transform: scale(1.2);
                margin-top: 1px;
            }
            .scoreBox, .tipsBox, .spaceBox {
                font-size: 1em;
                padding: 10px;
            }
            .error {
                font-size: 0.85em;
            }
        }
    </style>
</head>

<body>

<div id="loadingScreen" class="screen active">
    <p>Î™®Îç∏ Î°úÎî© Ï§ë... Ïû†ÏãúÎßå Í∏∞Îã§Î†§ Ï£ºÏÑ∏Ïöî.</p>
</div>

<div id="cameraScreen" class="screen">
    <div id="video-container">
        <video id="video" autoplay muted playsinline crossorigin="anonymous"></video>
        <canvas id="liveCanvas" width="640" height="480"></canvas>
    </div>

    <div class="button-group">
        <button id="analyzeBeforeBtn">üì∏ ÌòÑÏû¨ Í≥µÍ∞Ñ Î∂ÑÏÑù</button>
        <button id="analyzeAfterBtn" disabled>‚úÖ Ï†ïÎ¶¨ ÌõÑ Ï†êÏàò Îß§Í∏∞Í∏∞</button>
    </div>

    <p class="error" id="errorMessage"></p>
    <p id="analysisStatusMessage" style="text-align: center; color: #555; margin-top: 10px;"></p>
</div>

<div id="resultModalOverlay" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn" onclick="closeResultModal()">&times;</button>
        <h3 id="modalTitle"></h3>
        <div class="modal-img-container">
            <canvas id="modalCanvas" width="640" height="480"></canvas>
        </div>
        <div class="spaceBox" id="modalSpaceInfo"></div>
        <div class="tipsBox" id="modalTipsInfo"></div>
        <div class="scoreBox" id="modalScoreInfo"></div>
        <div id="modalChecklistInfo"></div>
        <p id="modalFeedbackMessage"></p>
        <button onclick="closeResultModal()">ÌôïÏù∏</button>
        <button id="resetAppBtn" style="background: #dc3545; display: none;" onclick="resetApplication()">Îã§Ïãú ÏãúÏûë</button>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.11.0"></script>
<script>
    const loadingScreen = document.getElementById("loadingScreen");
    const cameraScreen = document.getElementById("cameraScreen");
    const video = document.getElementById("video");
    const liveCanvas = document.getElementById("liveCanvas");
    const liveCtx = liveCanvas.getContext("2d");
    const analyzeBeforeBtn = document.getElementById("analyzeBeforeBtn");
    const analyzeAfterBtn = document.getElementById("analyzeAfterBtn");
    const errorMessage = document.getElementById("errorMessage");
    const analysisStatusMessage = document.getElementById("analysisStatusMessage");

    const resultModalOverlay = document.getElementById("resultModalOverlay");
    const modalTitle = document.getElementById("modalTitle");
    const modalCanvas = document.getElementById("modalCanvas");
    const modalCtx = modalCanvas.getContext("2d");
    const modalSpaceInfo = document.getElementById("modalSpaceInfo");
    const modalTipsInfo = document.getElementById("modalTipsInfo");
    const modalScoreInfo = document.getElementById("modalScoreInfo");
    const modalChecklistInfo = document.getElementById("modalChecklistInfo");
    const modalFeedbackMessage = document.getElementById("modalFeedbackMessage");
    const resetAppBtn = document.getElementById("resetAppBtn");

    let yoloModel = null;
    let customLabels = []; // label.txtÏóêÏÑú Î°úÎìúÌï† Ïª§Ïä§ÌÖÄ Î†àÏù¥Î∏î
    let beforeLabels = [];
    let beforeSnapshotData = null; 
    
    // YOLOv8 Î™®Îç∏Ïùò ÏûÖÎ†• ÌÅ¨Í∏∞ (Î™®Îç∏ ÌïôÏäµ Ïãú ÏÇ¨Ïö©Ìïú Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞ÏôÄ ÏùºÏπòÌï¥Ïïº Ìï®)
    const MODEL_INPUT_SIZE = 640; 
    const IOU_THRESHOLD = 0.45; // Intersection Over Union ÏûÑÍ≥ÑÍ∞í (NMSÏö©)
    const CONF_THRESHOLD = 0.25; // Confidence Score ÏûÑÍ≥ÑÍ∞í (Í∞ùÏ≤¥ ÌïÑÌÑ∞ÎßÅÏö©)

    // Open Images V7 Î†àÏù¥Î∏î Ï§ë Î∞©ÏóêÏÑú 'Ïñ¥ÏßÄÎüΩÌûò'ÏúºÎ°ú Í∞ÑÏ£ºÎê† Ïàò ÏûàÎäî Í∞ùÏ≤¥Îì§Ïùò Î™©Î°ù (ÏµúÏ¢Ö ÏóÖÎç∞Ïù¥Ìä∏Îê®)
    const hardcodedMessyLabels = [
        // ÏùòÎ•ò Î∞è Í∞úÏù∏ Ïö©Ìíà
        'Backpack', 'Bag', 'Briefcase', 'Clothing', 'Coat', 'Dress', 'Footwear', 'Glove', 'Handbag', 'Hat', 'Helmet',
        'High heels', 'Jacket', 'Jeans', 'Luggage and bags', 'Miniskirt', 'Pants', 'Sandal', 'Scarf', 'Shirt', 'Shoes',
        'Shorts', 'Sock', 'Suit', 'Suitcase', 'Swimwear', 'Tie', 'Trousers', 'Watch',
        'Glasses', 'Sunglasses', 'Earrings', 'Necklace', 'Ring', 'Crown', 'Tiara', 'Fashion accessory',
        'Cosmetics', 'Face powder', 'Hair dryer', 'Hair spray', 'Lipstick', 'Perfume', 'Toothbrush', 'Personal care',

        // Ï±Ö Î∞è ÏÇ¨Î¨¥Ïö©Ìíà
        'Book', 'Bookcase', 'Paper', 'Magazine', 'Pen', 'Pencil case', 'Pencil sharpener', 'Eraser', 'Ring binder',
        'Office supplies', 'Ruler', 'Stapler', 'Whiteboard', 'Printer', 'Fax',

        // ÏùåÏãù Î∞è Ï£ºÎ∞© Ïö©Ìíà (Î∞©Ïóê ÏûàÏùÑ Í≤ΩÏö∞ Ïñ¥ÏßÄÎü¨ÏõÄ)
        'Apple', 'Banana', 'Bread', 'Cabbage', 'Carrot', 'Cheese', 'Common fig', 'Cucumber', 'Egg (Food)', 'Fruit',
        'Garden Asparagus', 'Grape', 'Grapefruit', 'Lemon', 'Mango', 'Mushroom', 'Orange', 'Pancake', 'Peach', 'Pear',
        'Pineapple', 'Pizza', 'Potato', 'Pumpkin', 'Radish', 'Salad', 'Sandwich', 'Snack', 'Strawberry', 'Sushi', 'Taco',
        'Tart', 'Tomato', 'Vegetable', 'Watermelon', 'Winter melon', 'Zucchini',
        'Beer', 'Coffee', 'Cocktail', 'Drink', 'Juice', 'Milk', 'Tea', 'Wine',
        'Bagel', 'Baked goods', 'Candy', 'Cookie', 'Croissant', 'Dessert', 'Doughnut', 'Hamburger', 'Hot dog', 'Ice cream',
        'Muffin', 'Popcorn', 'Pretzel', 'Submarine sandwich', 'Waffle',
        'Bottle', 'Bottle opener', 'Bowl', 'Can opener', 'Coffee cup', 'Container', 'Cooking spray', 'Cup', 'Drinking straw',
        'Frying pan', 'Jug', 'Kettle', 'Kitchen knife', 'Kitchen utensil', 'Kitchenware', 'Ladle', 'Measuring cup',
        'Mixing bowl', 'Mug', 'Plate', 'Platter', 'Saucer', 'Serving tray', 'Spice rack', 'Spoon', 'Teapot', 'Tin can',
        'Tableware', 'Whisk', 'Wine glass', 'Wok',

        // Í∞ÄÍµ¨ Î∞è ÏÜåÌíà (Î∞©ÏπòÎê† Í≤ΩÏö∞ Ïñ¥ÏßÄÎü¨ÏõÄ)
        'Chair', 'Couch', 'Bed', 'Desk', 'Nightstand', 'Table', 'Coffee table', 'Kitchen & dining room table', 'Stool',
        'Studio couch', 'Sofa bed', 'Cabinetry', 'Chest of drawers', 'Closet', 'Cupboard', 'Drawer', 'Filing cabinet',
        'Shelf', 'Wardrobe', 'Television', 'Computer keyboard', 'Computer monitor', 'Computer mouse', 'Laptop',
        'Mobile phone', 'Remote control', 'Tablet computer', 'Telephone', 'Ipod', 'Headphones', 'Speaker',
        'Alarm clock', 'Clock', 'Digital clock', 'Wall clock',
        'Lamp', 'Light bulb', 'Flowerpot', 'Houseplant', 'Vase', 'Picture frame', 'Poster', 'Mirror',
        'Pillow', 'Towel', 'Blanket', 'Curtain', 'Window blind',
        'Box', 'Plastic bag', 'Waste container', 

        // Ïû•ÎÇúÍ∞ê Î∞è Ïä§Ìè¨Ï∏† Ïö©Ìíà
        'Ball', 'Balloon', 'Doll', 'Flying disc', 'Toy', 'Teddy bear',
        'Baseball bat', 'Baseball glove', 'Billiard table', 'Bowling equipment', 'Cricket ball', 'Dumbbell', 'Football',
        'Football helmet', 'Golf ball', 'Golf cart', 'Racket', 'Rugby ball', 'Skateboard', 'Ski', 'Snowboard',
        'Sports equipment', 'Table tennis racket', 'Tennis ball', 'Tennis racket', 'Unicycle', 'Volleyball (Ball)',

        // Í∏∞ÌÉÄ (Î∞©Ïóê ÏûàÏùÑ Î≤ïÌïú Ïû°ÎèôÏÇ¨Îãà)
        'Accordion', 'Axe', 'Band-aid', 'Banjo', 'Barrel', 'Bell pepper', 'Binoculars', 'Blender', 'Bomb', 'Cello', 'Chime',
        'Chisel', 'Chopsticks', 'Coffeemaker', 'Coin', 'Corded phone', 'Crutch', 'Cutting board', 'Dagger', 'Dice',
        'Dishwasher', 'Door handle', 'Drill (Tool)', 'Drum', 'Fountain', 'Gas stove', 'Grinder', 'Guacamole', 'Guitar',
        'Hammer', 'Harmonica', 'Harp', 'Harpsichord', 'Heater', 'Honeycomb', 'Humidifier', 'Jacuzzi', 'Jet ski', 'Kite',
        'Knife', 'Ladder', 'Lantern', 'Light switch', 'Maracas', 'Mechanical fan', 'Medical equipment', 'Microphone',
        'Microwave oven', 'Mixer', 'Mixing bowl', 'Musical instrument', 'Musical keyboard', 'Nail (Construction)', 'Oboe', 'Office building',
        'Organ (Musical Instrument)', 'Oven', 'Paddle', 'Paper cutter', 'Paper towel', 'Pianoforte', 'Picnic basket',
        'Pliers', 'Plumbing fixture', 'Power plugs and sockets', 'Pressure cooker', 'Punching bag', 'Ratchet (Device)',
        'Refrigerator', 'Scissors', 'Screwdriver', 'Sewing machine', 'Shower', 'Sink', 'Slow cooker', 'Soap dispenser',
        'Spatula', 'Stethoscope', 'Stop sign', 'Syringe', 'Tank', 'Tap', 'Tool', 'Torch', 'Traffic light', 'Traffic sign',
        'Training bench', 'Treadmill', 'Tripod', 'Trombone', 'Trumpet', 'Umbrella', 'Waffle iron', 'Wheelchair', 'Wrench',
        'Wagon', 'Walkie-talkie', 'Water bottle', 'Water heater', 'Water cooler', 'Welding mask', 'Washing machine',
        'Vacuum cleaner', 'Steam iron'
    ];
    
    // Ï†êÏàò Í≥ÑÏÇ∞Ïóê Ïã§Ï†úÎ°ú ÏÇ¨Ïö©Îê† 'Ïñ¥ÏßÄÎüΩÌûò' Í∞ùÏ≤¥ Î™©Î°ù (hardcodedMessyLabelsÏôÄ customLabelsÏùò ÍµêÏßëÌï©)
    let messyLabelsForScoring = [];

    // label.txt ÌååÏùºÏùÑ Î°úÎìúÌïòÎäî Ìï®Ïàò
    async function loadLabels(path) {
        try {
            const response = await fetch(path);
            const text = await response.text();
            // 'names:' Ïù¥ÌõÑÏùò ÎùºÏù∏Îì§ÏùÑ ÌååÏã±
            const lines = text.split('\n');
            const startIndex = lines.findIndex(line => line.includes('names:')) + 1;
            const labels = [];
            for (let i = startIndex; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const match = line.match(/^\s*\d+:\s*(.*)/); // "570: Trombone" ÌòïÏãù ÌååÏã± (ÏãúÏûë Í≥µÎ∞±ÎèÑ Í≥†Î†§)
                    if (match && match[1]) {
                        labels.push(match[1].trim());
                    }
                }
            }
            return labels;
        } catch (error) {
            console.error("Error loading labels:", error);
            errorMessage.textContent = "‚ùó Î†àÏù¥Î∏î ÌååÏùºÏùÑ Î°úÎìúÌïòÎäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§: " + error.message;
            return [];
        }
    }

    // Ïª§Ïä§ÌÖÄ Î†àÏù¥Î∏îÏùÑ ÏÇ¨Ïö©Ïûê ÏπúÌôîÏ†ÅÏù∏ Ïù¥Î¶ÑÏúºÎ°ú Îß§ÌïëÌïòÍ≥†, ÌäπÏ†ï Í∞ùÏ≤¥ Í∑∏Î£πÌôî
    function mapLabelToFriendlyName(label) {
        if(!label) return '';
        // Open Images V7 Î†àÏù¥Î∏îÏùÄ Ïù¥ÎØ∏ ÏÇ¨Ïö©Ïûê ÏπúÌôîÏ†ÅÏù¥ÎØÄÎ°ú Í∑∏ÎåÄÎ°ú Î∞òÌôò
        return label; 
    }

    // ÌåÅ ÏÇ¨Ï†Ñ (YOLOv8 Î™®Îç∏Ïùò Ïª§Ïä§ÌÖÄ Î†àÏù¥Î∏îÏóê ÎßûÏ∂∞ ÏóÖÎç∞Ïù¥Ìä∏ ÌïÑÏöî)
    const tipDictionary = {
        'Book': "üìö Ï±ÖÏùÄ Ï±ÖÍΩÇÏù¥ÎÇò ÏÑ†Î∞òÏóê Ï†ïÎ¶¨Ìï¥ Ï£ºÏÑ∏Ïöî.",
        'Cup': "‚òï ÏªµÏùÄ ÏîªÏñ¥ÏÑú Í±¥Ï°∞ÎåÄÏóê ÎÜìÍ±∞ÎÇò ÏàòÎÇ©ÌïòÏÑ∏Ïöî.",
        'Bottle': "üß¥ Î≥ëÏùÄ ÎÇ¥Ïö©Î¨ºÏùÑ ÎπÑÏö∞Í≥† Î∂ÑÎ¶¨ÏàòÍ±∞ÌïòÍ±∞ÎÇò Ï†úÏûêÎ¶¨Ïóê Î≥¥Í¥ÄÌïòÏÑ∏Ïöî.",
        'Laptop': "üíª ÎÖ∏Ìä∏Î∂ÅÏùÄ ÏÇ¨Ïö© ÌõÑ Îã´ÏïÑÏÑú Ï†ïÌï¥ÏßÑ ÏúÑÏπòÏóê ÎÜìÏúºÏÑ∏Ïöî.",
        'Chair': "ü™ë ÏùòÏûêÎäî ÏÇ¨Ïö© ÌõÑ Ï±ÖÏÉÅ ÏïÑÎûòÎ°ú Î∞ÄÏñ¥ ÎÑ£Ïñ¥Ï£ºÏÑ∏Ïöî.",
        'Backpack': "üéí Í∞ÄÎ∞©ÏùÄ ÎÇ¥Ïö©Î¨ºÏùÑ ÎπÑÏö∞Í≥† Ï†úÏûêÎ¶¨Ïóê Í±∏Ïñ¥ÎëêÏÑ∏Ïöî.",
        'Mobile phone': "üì± Ìú¥ÎåÄÌè∞ÏùÄ Ï∂©Ï†Ñ ÏúÑÏπòÎÇò Ï†ÑÏö© Í±∞ÏπòÎåÄÏóê Î≥¥Í¥ÄÌïòÏÑ∏Ïöî.",
        'Remote control': "üïπÔ∏è Î¶¨Î™®Ïª®ÏùÄ Ï†úÏûêÎ¶¨Ïóê ÎëêÍ±∞ÎÇò ÏàòÎÇ©Ìï®Ïóê ÎÑ£Ïñ¥Ï£ºÏÑ∏Ïöî.",
        'Computer keyboard': "‚å®Ô∏è ÏÇ¨Ïö© ÌõÑÏóêÎäî Ï†ú ÏúÑÏπòÏóê ÎëêÍ±∞ÎÇò Ï†ïÎ¶¨ÌïòÏÑ∏Ïöî.",
        'Mouse': "üñ±Ô∏è ÏÇ¨Ïö© ÌõÑÏóêÎäî Ï†ú ÏúÑÏπòÏóê ÎëêÍ±∞ÎÇò Ï†ïÎ¶¨ÌïòÏÑ∏Ïöî.",
        'Toothbrush': "ü™• Ïπ´ÏÜîÏùÄ ÏÇ¨Ïö© ÌõÑ Ïπ´ÏÜîÍΩÇÏù¥Ïóê Ï†úÎåÄÎ°ú Î≥¥Í¥ÄÌïòÏÑ∏Ïöî.",
        'Clothing': "üëï Ïò∑ÏùÄ Ïò∑Ïû•Ïù¥ÎÇò ÏÑ∏ÌÉÅ Î∞îÍµ¨ÎãàÏóê ÎÑ£Ïñ¥Ï£ºÏÑ∏Ïöî.",
        'Shoes': "üëü Ïã†Î∞úÏùÄ Ïã†Î∞úÏû•Ïóê Ï†ïÎ¶¨Ìï¥ Ï£ºÏÑ∏Ïöî.",
        'Dishes': "üçΩÔ∏è Ï†ëÏãúÏôÄ Í∑∏Î¶áÏùÄ ÏÑ§Í±∞ÏßÄ ÌõÑ Ï†úÏûêÎ¶¨Ïóê ÏàòÎÇ©ÌïòÏÑ∏Ïöî.",
        'Paper': "üìÑ Ï¢ÖÏù¥Îäî Î∂ÑÎ•òÌïòÏó¨ Ïû¨ÌôúÏö©ÌïòÍ±∞ÎÇò ÌååÏùºÏóê Î≥¥Í¥ÄÌïòÏÑ∏Ïöî.",
        'Cosmetics': "üíÑ ÌôîÏû•ÌíàÏùÄ ÌôîÏû•ÎåÄÏóê Ï†ïÎèàÌïòÍ±∞ÎÇò ÏÑúÎûçÏóê Î≥¥Í¥ÄÌïòÏÑ∏Ïöî.",
        'Toy': "üß∏ Ïû•ÎÇúÍ∞êÏùÄ ÎÜÄÏù¥ ÌõÑ Ïû•ÎÇúÍ∞ê ÏÉÅÏûêÏóê Ï†ïÎ¶¨ÌïòÏÑ∏Ïöî.",
        'Waste container': "üóëÔ∏è Ïì∞Î†àÍ∏∞ÌÜµÏù¥ Í∞ÄÎìù Ï∞ºÎã§Î©¥ ÎπÑÏõåÏ£ºÏÑ∏Ïöî.",
        'Pillow': "üõå Î≤†Í∞úÎäî Ïπ®ÎåÄ ÏúÑÏóê Í∞ÄÏßÄÎü∞Ìûà ÎÜìÏúºÏÑ∏Ïöî.",
        'Towel': "üõÄ ÏàòÍ±¥ÏùÄ ÏÇ¨Ïö© ÌõÑ Îπ®ÎûòÌÜµÏóê ÎÑ£Í±∞ÎÇò Í±¥Ï°∞ÎåÄÏóê ÎÑêÏñ¥Ï£ºÏÑ∏Ïöî.",
        'Bag': "üëú Í∞ÄÎ∞©ÏùÄ ÎÇ¥Ïö©Î¨ºÏùÑ ÎπÑÏö∞Í≥† Ï†ïÌï¥ÏßÑ Í≥≥Ïóê ÎëêÏÑ∏Ïöî.",
        'Food': "üçé ÏùåÏãùÎ¨º Ïì∞Î†àÍ∏∞Îäî Ï†úÎïå Î≤ÑÎ¶¨Í≥†, ÎÇ®ÏùÄ ÏùåÏãùÏùÄ ÎÉâÏû•Í≥†Ïóê Î≥¥Í¥ÄÌïòÏÑ∏Ïöî."
        // Ï∂îÍ∞Ä: Îã§Î•∏ Î†àÏù¥Î∏îÏóê ÎåÄÌïú ÌåÅÏùÑ Ïó¨Í∏∞Ïóê Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏäµÎãàÎã§.
    };

    // Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ ÏÇ¨Ï†Ñ (YOLOv8 Î™®Îç∏Ïùò Ïª§Ïä§ÌÖÄ Î†àÏù¥Î∏îÏóê ÎßûÏ∂∞ ÏóÖÎç∞Ïù¥Ìä∏ ÌïÑÏöî)
    const checklistDictionary = {
        'Book': ["Ï±ÖÍΩÇÏù¥Ïóê ÎÑ£Í∏∞", "ÏùΩÏßÄ ÏïäÎäî Ï±Ö Î∂ÑÎ•ò"],
        'Cup': ["Ïªµ ÏîªÍ∏∞", "Í±¥Ï°∞ÎåÄÏóê ÎÜìÍ∏∞", "ÏàòÎÇ©ÌïòÍ∏∞"],
        'Bottle': ["ÎöúÍªë Îã´Í∏∞", "Ïû¨ÌôúÏö©Ìï®Ïóê ÎÑ£Í∏∞", "ÎÇ¥Ïö©Î¨º ÎπÑÏö∞Í∏∞"],
        'Laptop': ["ÎçÆÍ∞ú Îã´Í∏∞", "Ï∂©Ï†ÑÍ∏∞ Ï†ïÎ¶¨", "Ï†ÑÏõê ÎÅÑÍ∏∞"],
        'Chair': ["Ï†ïÏúÑÏπò Ï†ïÎ†¨", "ÏùòÏûê ÏúÑ Î¨ºÍ±¥ Ï†ïÎ¶¨"],
        'Backpack': ["ÎÇ¥Ïö©Î¨º ÎπÑÏö∞Í∏∞", "Ï†úÏûêÎ¶¨Ïóê Í±∏Í∏∞/ÎëêÍ∏∞"],
        'Mobile phone': ["Ï∂©Ï†Ñ ÏúÑÏπòÏóê ÎëêÍ∏∞", "Í±∞ÏπòÎåÄÏóê ÎÜìÍ∏∞"],
        'Remote control': ["Ï†úÏûêÎ¶¨Î°ú ÏòÆÍ∏∞Í∏∞"],
        'Computer keyboard': ["Ï†ïÎ¶¨ ÌõÑ Ï†úÏûêÎ¶¨Ïóê ÎÜìÍ∏∞"],
        'Mouse': ["Ï†ïÎ¶¨ ÌõÑ Ï†úÏûêÎ¶¨Ïóê ÎÜìÍ∏∞"],
        'Toothbrush': ["Ïπ´ÏÜîÍΩÇÏù¥Ïóê Î≥¥Í¥ÄÌïòÍ∏∞"],
        'Clothing': ["Ïò∑Ïû•/ÏÑúÎûçÏóê ÎÑ£Í∏∞", "ÏÑ∏ÌÉÅ Î∞îÍµ¨ÎãàÏóê ÎÑ£Í∏∞"],
        'Shoes': ["Ïã†Î∞úÏû•Ïóê ÎÑ£Í∏∞", "Ìùô ÌÑ∏Í∏∞"],
        'Dishes': ["ÏÑ§Í±∞ÏßÄ ÌïòÍ∏∞", "Í±¥Ï°∞/ÏàòÎÇ©ÌïòÍ∏∞"],
        'Paper': ["Î∂ÑÎ•òÌïòÏó¨ Ïû¨ÌôúÏö©", "ÏÑúÎ•òÏ≤†Ïóê Ï†ïÎ¶¨"],
        'Cosmetics': ["ÌôîÏû•ÎåÄÏóê Ï†ïÎèàÌïòÍ∏∞", "ÏÑúÎûçÏóê Î≥¥Í¥Ä"],
        'Toy': ["Ïû•ÎÇúÍ∞ê ÏÉÅÏûêÏóê ÎÑ£Í∏∞", "Ï¢ÖÎ•òÎ≥ÑÎ°ú Î∂ÑÎ•ò"],
        'Waste container': ["Ïì∞Î†àÍ∏∞ ÎπÑÏö∞Í∏∞", "Ïì∞Î†àÍ∏∞ÌÜµ Îã¶Í∏∞"],
        'Pillow': ["Ïπ®ÎåÄ Ï†ïÎ¶¨ÌïòÍ∏∞", "Î≤†Í∞ú Ïª§Î≤Ñ ÍµêÏ≤¥"],
        'Towel': ["Îπ®ÎûòÌÜµÏóê ÎÑ£Í∏∞", "Í±¥Ï°∞ÎåÄÏóê ÎÑêÍ∏∞"],
        'Bag': ["ÎÇ¥Ïö©Î¨º ÎπÑÏö∞Í∏∞", "Ï†ïÌï¥ÏßÑ Í≥≥Ïóê ÎëêÍ∏∞"],
        'Food': ["ÎÇ®ÏùÄ ÏùåÏãù ÎÉâÏû•Í≥†Ïóê ÎÑ£Í∏∞", "Ïú†ÌÜµÍ∏∞Ìïú ÌôïÏù∏"]
        // Ï∂îÍ∞Ä: Îã§Î•∏ Î†àÏù¥Î∏îÏóê ÎåÄÌïú Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏Î•º Ïó¨Í∏∞Ïóê Ï∂îÍ∞ÄÌï† Ïàò ÏûàÏäµÎãàÎã§.
    };

    // Í≥µÍ∞Ñ Ï∂îÎ°†ÏùÑ ÏúÑÌïú ÌÇ§ÏõåÎìú Í∑∏Î£π (YOLOv8 Î™®Îç∏Ïùò Î†àÏù¥Î∏î Í∏∞Ï§ÄÏúºÎ°ú ÌôïÏû• ÌïÑÏöî)
    const spaceGroups = {
        'Ï±ÖÏÉÅ Ï£ºÎ≥Ä': ["Book", "Laptop", "Mouse", "Computer keyboard", "Cup", "Chair", "Pen", "Paper"],
        'Ïπ®Ïã§': ["Bed", "Pillow", "Blanket", "Book", "Clothing", "Nightstand"], 
        'Ï£ºÎ∞©': ["Cup", "Bottle", "Bowl", "Refrigerator", "Microwave oven", "Plate", "Fork", "Knife", "Spoon", "Oven"], 
        'Í±∞Ïã§': ["Couch", "Television", "Potted plant", "Chair", "Remote control", "Bookcase", "Coffee table", "Vase", "Picture frame"], 
        'ÏöïÏã§': ["Toilet", "Toothbrush", "Cosmetics", "Mirror", "Towel", "Shower", "Soap dispenser"],
        'ÌòÑÍ¥Ä/Î≥µÎèÑ': ["Shoes", "Backpack", "Bag", "Coat", "Hat", "Umbrella"]
        // TODO: Ïª§Ïä§ÌÖÄ Î™®Îç∏Ïù¥ Í∞êÏßÄÌïòÎäî Í∞ùÏ≤¥Î•º ÌôúÏö©ÌïòÏó¨ Í≥µÍ∞Ñ Í∑∏Î£πÏùÑ ÌôïÏû•ÌïòÏÑ∏Ïöî.
    };

    // ÌòÑÏû¨ ÌôúÏÑ±ÌôîÎêú ÌôîÎ©¥ÏùÑ Î≥ÄÍ≤ΩÌïòÎäî Ìï®Ïàò
    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(screen => {
            screen.classList.remove('active');
        });
        document.getElementById(screenId).classList.add('active');
    }

    // Î™®Îã¨ Ïó¥Í∏∞/Îã´Í∏∞
    function openResultModal(title, spaceInfo, tipsInfo, scoreInfo, checklistInfo, feedbackMessage, showResetBtn = false) {
        modalTitle.textContent = title;
        modalSpaceInfo.innerHTML = `<h3>üè† ÏòàÏÉÅ Í≥µÍ∞Ñ</h3><p>${spaceInfo}</p>`;
        modalTipsInfo.innerHTML = `<h3>üí° Ï†ïÎ¶¨ ÌåÅ</h3><p>${tipsInfo}</p>`;
        modalScoreInfo.innerHTML = scoreInfo ? `<h3>‚ú® Ï†ïÎ¶¨ Ï†êÏàò</h3><p>${scoreInfo}</p>` : '';
        modalChecklistInfo.innerHTML = checklistInfo ? `<h3>‚úîÔ∏è Ï†ïÎ¶¨ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏</h3>${checklistInfo}` : '';
        modalFeedbackMessage.textContent = feedbackMessage;
        resetAppBtn.style.display = showResetBtn ? 'block' : 'none'; // Îã§Ïãú ÏãúÏûë Î≤ÑÌäº ÌëúÏãú Ïó¨Î∂Ä

        resultModalOverlay.style.display = 'flex'; // flexÎ°ú Î≥ÄÍ≤ΩÌïòÏó¨ Í∞ÄÏö¥Îç∞ Ï†ïÎ†¨ Ïú†ÏßÄ
    }

    function closeResultModal() {
        resultModalOverlay.style.display = 'none';
    }

    // Ïñ¥Îñ§ Í≥µÍ∞ÑÏù∏ÏßÄ Ï∂îÎ°† (Í∞ÄÏû• ÎßéÏù¥ Í∞êÏßÄÎêú Í∞ùÏ≤¥Í∞Ä ÏÜçÌïú Í∑∏Î£πÏúºÎ°ú ÌåêÎã®)
    function guessSpace(labels) {
        const counts = {};
        for (const key in spaceGroups) {
            counts[key] = labels.filter(l => spaceGroups[key].includes(l)).length;
        }
        const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
        if (sorted.length > 0 && sorted[0][1] > 0) { // ÏµúÏÜå 1Í∞ú Ïù¥ÏÉÅ Í∞êÏßÄÎê† Îïå Ïú†Ìö®
            return sorted[0][0];
        }
        return "Ïïå Ïàò ÏóÜÎäî Í≥µÍ∞Ñ";
    }

    function generateTips(labels) {
        const uniqueLabels = [...new Set(labels)];
        const tips = uniqueLabels.map(l => tipDictionary[l]).filter(Boolean);
        return tips.length ? tips.join(" ") : "üëç ÌòÑÏû¨ ÌäπÎ≥ÑÌûà Ï†ïÎ¶¨Ìï† Î¨ºÍ±¥Ïù¥ Í∞êÏßÄÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§!";
    }

    function calculateScore(before, after) {
        let score = 50; // Í∏∞Î≥∏ Ï†êÏàò
        let feedback = "";

        const beforeSet = new Set(before.map(l => l.toLowerCase())); // ÎπÑÍµêÎ•º ÏúÑÌï¥ ÏÜåÎ¨∏ÏûêÎ°ú Î≥ÄÌôò
        const afterCounts = {};
        after.map(l => l.toLowerCase()).forEach(item => { afterCounts[item] = (afterCounts[item] || 0) + 1; }); // ÏÜåÎ¨∏ÏûêÎ°ú Î≥ÄÌôòÌïòÏó¨ Ïπ¥Ïö¥Ìä∏

        let removedCount = 0;
        let addedCount = 0;
        let improvedMessyScore = 0;

        const beforeCounts = {};
        before.map(l => l.toLowerCase()).forEach(item => { beforeCounts[item] = (beforeCounts[item] || 0) + 1; }); // ÏÜåÎ¨∏ÏûêÎ°ú Î≥ÄÌôòÌïòÏó¨ Ïπ¥Ïö¥Ìä∏

        // ÏÇ¨ÎùºÏßÑ Í∞ùÏ≤¥ Î∞è Í∞êÏÜåÌïú Ïñ¥ÏßÄÎüΩÌûò Í∞ùÏ≤¥ ÌôïÏù∏
        beforeSet.forEach(item => { // itemÏùÄ Ïù¥ÎØ∏ ÏÜåÎ¨∏Ïûê
            const beforeQty = beforeCounts[item] || 0;
            const afterQty = afterCounts[item] || 0;

            if (beforeQty > afterQty) {
                removedCount += (beforeQty - afterQty);
                // messyLabelsForScoringÎèÑ ÏÜåÎ¨∏ÏûêÎ°ú Ï†ÄÏû•ÎêòÏñ¥ ÏûàÏúºÎØÄÎ°ú, itemÍ≥º ÏßÅÏ†ë ÎπÑÍµê
                if (messyLabelsForScoring.includes(item)) { 
                    improvedMessyScore += (beforeQty - afterQty) * 10; // Ïñ¥ÏßÄÎüΩÌûò Í∞ùÏ≤¥ Í∞êÏÜå Ïãú Í∞ÄÏ§ëÏπò
                }
            }
        });

        // Ï∂îÍ∞ÄÎêú Í∞ùÏ≤¥ ÌôïÏù∏
        after.map(l => l.toLowerCase()).forEach(item => { // itemÏùÄ Ïù¥ÎØ∏ ÏÜåÎ¨∏Ïûê
            const beforeQty = beforeCounts[item] || 0;
            const afterQty = afterCounts[item] || 0;
            if (afterQty > beforeQty) {
                addedCount += (afterQty - beforeQty);
            }
        });

        score += removedCount * 5; // ÏÇ¨ÎùºÏßÑ Í∞ùÏ≤¥Îãπ Ï†êÏàò
        score += improvedMessyScore; // Ïñ¥ÏßÄÎüΩÌûò Í∞ùÏ≤¥ Í∞êÏÜåÎ°ú Ïù∏Ìïú Ï∂îÍ∞Ä Ï†êÏàò
        score -= addedCount * 3; // ÏÉàÎ°úÏö¥ Í∞ùÏ≤¥Í∞Ä ÏÉùÍ∏∞Î©¥ Í∞êÏ†ê (ÏÉàÎ°úÏö¥ Ïì∞Î†àÍ∏∞ Îì±)

        if (score > 100) score = 100;
        if (score < 0) score = 0;

        if (score >= 90) feedback = "Ï†ïÎßê Íπ®ÎÅóÌïòÍ≤å Ï†ïÎ¶¨ÌñàÏñ¥Ïöî! ÌõåÎ•≠Ìï©ÎãàÎã§! üéâ";
        else if (score >= 70) feedback = "ÏïÑÏ£º Ïûò Ï†ïÎ¶¨ÌñàÏñ¥Ïöî! Îã§ÏùåÏóî Îçî ÏôÑÎ≤ΩÌïòÍ≤å! üëç";
        else if (score >= 50) feedback = "ÍΩ§ Í¥úÏ∞ÆÍ≤å Ï†ïÎ¶¨ÌñàÎÑ§Ïöî. Ï°∞Í∏àÎßå Îçî ÎÖ∏Î†•ÌïòÎ©¥ ÏôÑÎ≤ΩÌï¥Ï†∏Ïöî! üòâ";
        else feedback = "Ï°∞Í∏à Îçî Ï†ïÎ¶¨Ìï¥Ïïº Ìï† Í≤É Í∞ôÏïÑÏöî. Îã§Ïùå Î≤àÏóêÎäî Îçî ÏûòÌï† Ïàò ÏûàÏñ¥Ïöî! üí™";

        return { score: `üßπ Ï†ïÎ¶¨ Ï†êÏàò: ${score}Ï†ê (Ï†ïÎ¶¨ Ï†Ñ ${before.length}Í∞ú ‚Üí Ï†ïÎ¶¨ ÌõÑ ${after.length}Í∞ú Í∞êÏßÄ)`, feedback: feedback };
    }

    function generateChecklistHtml(labels) {
        let html = `<ul>`; 
        const uniqueLabels = [...new Set(labels)]; // ÏõêÎ≥∏ Î†àÏù¥Î∏î Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
        let hasTasks = false;

        uniqueLabels.forEach(label => {
            const tasks = checklistDictionary[label];
            if (tasks && tasks.length > 0) {
                hasTasks = true;
                html += `<li><strong>${mapLabelToFriendlyName(label)} Í¥ÄÎ†®:</strong></li>`;
                tasks.forEach(task => {
                    html += `<li><input type="checkbox"> ${task}</li>`;
                });
            }
        });

        if (!hasTasks) {
            html += `<li>ÌòÑÏû¨ Ï†ïÎ¶¨Ìï† Ìï≠Î™©Ïù¥ ÏóÜÏäµÎãàÎã§.</li>`;
        }
        html += '</ul>';
        return html;
    }

    // Ï∫îÎ≤ÑÏä§Ïóê Î∞îÏö¥Îî© Î∞ïÏä§ Í∑∏Î¶¨Í∏∞
    function drawBoundingBoxes(targetCtx, targetCanvas, results) {
        // Ïù¥ÎØ∏ analyzeSnapshotÏóêÏÑú ÏõêÎ≥∏ Ïù¥ÎØ∏ÏßÄÎ•º Í∑∏Î†∏Í±∞ÎÇò, liveCanvasÎäî videoÍ∞Ä Î∞∞Í≤ΩÏù¥ÎØÄÎ°ú clearRectÎßå
        // targetCtx.clearRect(0, 0, targetCanvas.width, targetCanvas.height); 

        results.forEach(prediction => {
            const [x, y, width, height] = prediction.bbox;
            targetCtx.strokeStyle = '#00FF00'; // Ï¥àÎ°ùÏÉâ Î∞ïÏä§
            targetCtx.lineWidth = 3;
            targetCtx.strokeRect(x, y, width, height);

            targetCtx.fillStyle = '#00FF00'; // Ï¥àÎ°ùÏÉâ Í∏ÄÏûê Î∞∞Í≤Ω
            targetCtx.font = 'bold 18px Noto Sans KR';
            const friendlyLabel = mapLabelToFriendlyName(prediction.class);
            const text = `${friendlyLabel} (${Math.round(prediction.score * 100)}%)`;
            const textWidth = targetCtx.measureText(text).width;
            
            // ÌÖçÏä§Ìä∏ Î∞∞Í≤ΩÏùÑ Î∞ïÏä§ ÏúÑÏóê Í∑∏Î¶¨Îêò, Ï∫îÎ≤ÑÏä§ ÏÉÅÎã®ÏùÑ Î≤óÏñ¥ÎÇòÏßÄ ÏïäÎèÑÎ°ù Ï°∞Ï†ï
            const textBgY = y - 20;
            const textY = y - 5;

            if (textBgY < 0) { // ÌÖçÏä§Ìä∏Í∞Ä Ï∫îÎ≤ÑÏä§ ÏÉÅÎã®ÏùÑ Î≤óÏñ¥ÎÇòÎäî Í≤ΩÏö∞
                targetCtx.fillRect(x, y, textWidth + 8, 20); // Î∞ïÏä§ ÏãúÏûëÏ†êÏóê Í∑∏Î¶¨Í∏∞
                targetCtx.fillStyle = '#000000';
                targetCtx.fillText(text, x + 4, y + 15); // Í∏ÄÏûê ÏúÑÏπò Ï°∞Ï†ï
            } else {
                targetCtx.fillRect(x, textBgY, textWidth + 8, 20);
                targetCtx.fillStyle = '#000000';
                targetCtx.fillText(text, x + 4, textY);
            }
        });
    }


    async function processYoloOutput(output, imgWidth, imgHeight, labels, iouThreshold, confThreshold) {
        let detections = [];
        const data = output.dataSync(); 

        const boxes = [];
        const scores = [];
        const classes = [];

        const numPredictions = output.shape[1];
        const numClasses = output.shape[2] - 4; 

        // Î™®Îç∏ Ï∂úÎ†• ÌÖêÏÑúÍ∞Ä [1, num_predictions, x_center, y_center, width, height, class_scores...] ÌòïÌÉúÏùº Îïå
        for (let i = 0; i < numPredictions; i++) {
            const offset = i * (4 + numClasses);
            const bbox = [
                data[offset],      // x_center (normalized)
                data[offset + 1],  // y_center (normalized)
                data[offset + 2],  // width (normalized)
                data[offset + 3]   // height (normalized)
            ];

            // ÌÅ¥ÎûòÏä§ Ï†êÏàò Î∞∞Ïó¥ÏóêÏÑú Í∞ÄÏû• ÎÜíÏùÄ Ï†êÏàòÏôÄ Ìï¥Îãπ ÌÅ¥ÎûòÏä§ Ïù∏Îç±Ïä§ Ï∞æÍ∏∞
            let maxScore = -1;
            let classId = -1;
            for (let j = 0; j < numClasses; j++) {
                const classScore = data[offset + 4 + j];
                if (classScore > maxScore) {
                    maxScore = classScore;
                    classId = j;
                }
            }

            if (maxScore >= confThreshold) {
                // YOLO Ï∂úÎ†• (cx, cy, w, h)Î•º (x1, y1, w, h)Î°ú Î≥ÄÌôòÌïòÍ≥†, Ïù¥ÎØ∏ÏßÄ ÌÅ¨Í∏∞Ïóê ÎßûÏ∂∞ Ïä§ÏºÄÏùºÎßÅ
                const x_center = bbox[0] * imgWidth;
                const y_center = bbox[1] * imgHeight;
                const width = bbox[2] * imgWidth;
                const height = bbox[3] * imgHeight;

                const x1 = x_center - width / 2;
                const y1 = y_center - height / 2;

                boxes.push([x1, y1, x1 + width, y1 + height]); // NMSÎ•º ÏúÑÌï¥ [x1, y1, x2, y2]
                scores.push(maxScore);
                classes.push(classId);
            }
        }
        
        // ÎπÑÎèôÍ∏∞ NMS Ïã§Ìñâ
        const nmsTensor = await tf.image.nonMaxSuppressionAsync(
            tf.tensor2d(boxes),
            tf.tensor1d(scores),
            boxes.length, // maxNumBoxes
            iouThreshold,
            confThreshold
        );

        const nmsIndices = await nmsTensor.array();

        // NMS Í≤∞Í≥ºÎ•º Î∞îÌÉïÏúºÎ°ú ÏµúÏ¢Ö Í∞êÏßÄ Í≤∞Í≥º ÏÉùÏÑ±
        for (const i of nmsIndices) {
            detections.push({
                bbox: [boxes[i][0], boxes[i][1], boxes[i][2] - boxes[i][0], boxes[i][3] - boxes[i][1]], // [x, y, width, height] ÌòïÏãù
                class: labels[classes[i]], // customLabels Î∞∞Ïó¥ÏóêÏÑú Ïã§Ï†ú ÌÅ¥ÎûòÏä§ Ïù¥Î¶ÑÏùÑ Í∞ÄÏ†∏Ïò¥
                score: scores[i]
            });
        }
        
        return detections;
    }


    // Ïã§ÏãúÍ∞Ñ ÎπÑÎîîÏò§ Ïä§Ìä∏Î¶ºÏóê Î∞îÏö¥Îî© Î∞ïÏä§ Í∑∏Î¶¨Í∏∞ (Ïù¥Ï†ú YOLOv8 ÏÇ¨Ïö©)
    async function detectLiveObjects() {
        if (!yoloModel || video.paused || video.ended) {
            setTimeout(() => requestAnimationFrame(detectLiveObjects), 100); 
            return;
        }

        liveCtx.clearRect(0, 0, liveCanvas.width, liveCanvas.height); 
        try {
            // ÎπÑÎîîÏò§ ÌîÑÎ†àÏûÑÏùÑ ÌÖêÏÑúÎ°ú Î≥ÄÌôòÌïòÍ≥† YOLOv8 Î™®Îç∏ ÏûÖÎ†•Ïóê ÎßûÏ∂∞ Ï†ÑÏ≤òÎ¶¨
            const tfImage = tf.browser.fromPixels(video);
            const resized = tf.image.resizeBilinear(tfImage, [MODEL_INPUT_SIZE, MODEL_INPUT_SIZE]);
            const normalized = resized.div(255.0); // 0-1 Ïä§ÏºÄÏùºÎ°ú Ï†ïÍ∑úÌôî
            const expanded = normalized.expandDims(0); // Î∞∞Ïπò Ï∞®Ïõê Ï∂îÍ∞Ä

            // YOLOv8 Î™®Îç∏ Ï∂îÎ°†
            const predictions = await yoloModel.executeAsync(expanded);
            
            // ÌÖêÏÑú Î©îÎ™®Î¶¨ Ìï¥Ï†ú
            tfImage.dispose();
            resized.dispose();
            normalized.dispose();
            expanded.dispose();

            // YOLOv8 Î™®Îç∏ Ï∂úÎ†• ÌõÑÏ≤òÎ¶¨
            const results = await processYoloOutput(predictions, video.videoWidth, video.videoHeight, customLabels, IOU_THRESHOLD, CONF_THRESHOLD);
            
            drawBoundingBoxes(liveCtx, liveCanvas, results);

        } catch (e) {
            console.error("Ïã§ÏãúÍ∞Ñ Í∞êÏßÄ Ïò§Î•ò:", e);
            // Ïã§ÏãúÍ∞Ñ Í∞êÏßÄ Ïò§Î•òÎäî ÏÇ¨Ïö©ÏûêÏóêÍ≤å ÏßÅÏ†ë ÌëúÏãúÌïòÏßÄ ÏïäÍ≥† ÏΩòÏÜîÏóêÎßå Î°úÍπÖÌï©ÎãàÎã§.
            // errorMessage.textContent = "‚ùó Ïã§ÏãúÍ∞Ñ Í∞êÏßÄ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: " + e.message;
        }
        
        // requestAnimationFrame ÎåÄÏã† setTimeoutÏùÑ ÏÇ¨Ïö©ÌïòÎ©¥ ÌîÑÎ†àÏûÑ ÎìúÎûçÏù¥ ÏûàÏùÑ ÎïåÎèÑ ÏïàÏ†ïÏ†ÅÏúºÎ°ú ÎèôÏûë
        setTimeout(() => requestAnimationFrame(detectLiveObjects), 100);
    }

    async function analyzeSnapshot(stage) {
        errorMessage.textContent = "";
        analysisStatusMessage.textContent = "üîç Î∂ÑÏÑù Ï§ë...";
        analyzeBeforeBtn.disabled = true;
        analyzeAfterBtn.disabled = true;

        if (!yoloModel) {
            errorMessage.textContent = "‚ùó Î™®Îç∏Ïù¥ ÏïÑÏßÅ Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.";
            analysisStatusMessage.textContent = "";
            analyzeBeforeBtn.disabled = false;
            return;
        }

        try {
            // ÎπÑÎîîÏò§ ÌîÑÎ†àÏûÑÏù¥ Ï§ÄÎπÑÎêòÏóàÎäîÏßÄ ÌôïÏù∏
            if (video.readyState < 2) {
                throw new Error("ÎπÑÎîîÏò§ ÌîÑÎ†àÏûÑÏù¥ ÏïÑÏßÅ Ï§ÄÎπÑÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.");
            }

            // Ï∫îÎ≤ÑÏä§ ÌÅ¨Í∏∞Î•º ÎπÑÎîîÏò§ ÌÅ¨Í∏∞ÏôÄ ÎßûÏ∂§
            modalCanvas.width = video.videoWidth;
            modalCanvas.height = video.videoHeight;

            // ÎπÑÎîîÏò§ ÌîÑÎ†àÏûÑÏùÑ Ï∫îÎ≤ÑÏä§Ïóê Í∑∏Î¶¨Í∏∞
            modalCtx.clearRect(0, 0, modalCanvas.width, modalCanvas.height);
            modalCtx.drawImage(video, 0, 0, modalCanvas.width, modalCanvas.height);

            // Ïä§ÎÉÖÏÉ∑ Ïù¥ÎØ∏ÏßÄÎ•º ÌÖêÏÑúÎ°ú Î≥ÄÌôòÌïòÍ≥† YOLOv8 Î™®Îç∏ ÏûÖÎ†•Ïóê ÎßûÏ∂∞ Ï†ÑÏ≤òÎ¶¨
            const tfImage = tf.browser.fromPixels(modalCanvas);
            const resized = tf.image.resizeBilinear(tfImage, [MODEL_INPUT_SIZE, MODEL_INPUT_SIZE]);
            const normalized = resized.div(255.0); // 0-1 Ïä§ÏºÄÏùºÎ°ú Ï†ïÍ∑úÌôî
            const expanded = normalized.expandDims(0); // Î∞∞Ïπò Ï∞®Ïõê Ï∂îÍ∞Ä

            // YOLOv8 Î™®Îç∏ Ï∂îÎ°†
            const predictions = await yoloModel.executeAsync(expanded);
            
            // ÌÖêÏÑú Î©îÎ™®Î¶¨ Ìï¥Ï†ú
            tfImage.dispose();
            resized.dispose();
            normalized.dispose();
            expanded.dispose();

            // YOLOv8 Î™®Îç∏ Ï∂úÎ†• ÌõÑÏ≤òÎ¶¨
            const results = await processYoloOutput(predictions, modalCanvas.width, modalCanvas.height, customLabels, IOU_THRESHOLD, CONF_THRESHOLD);
            
            const rawLabels = results.map(r => r.class); 

            // Î™®Îã¨ Ï∫îÎ≤ÑÏä§Ïóê Î∞îÏö¥Îî© Î∞ïÏä§ Í∑∏Î¶¨Í∏∞
            drawBoundingBoxes(modalCtx, modalCanvas, results);

            const spaceGuess = guessSpace(rawLabels);
            const tips = generateTips(rawLabels);
            const checklistHtml = generateChecklistHtml(rawLabels);

            if (stage === 'before') {
                beforeLabels = rawLabels;
                analysisStatusMessage.textContent = "‚úÖ Ï†ïÎ¶¨ Ï†Ñ Î∂ÑÏÑù ÏôÑÎ£å! Ïù¥Ï†ú Ï†ïÎ¶¨ ÌõÑ Îã§Ïãú Î∂ÑÏÑùÌï¥Î≥¥ÏÑ∏Ïöî.";
                analyzeAfterBtn.disabled = false;
                analyzeBeforeBtn.textContent = "üì∏ Îã§Ïãú Î∂ÑÏÑùÌïòÍ∏∞ (Ï†ïÎ¶¨ Ï†Ñ)";
                openResultModal(
                    "üßπ Ï†ïÎ¶¨ Ï†Ñ Î∂ÑÏÑù Í≤∞Í≥º",
                    spaceGuess,
                    tips,
                    null, // Ï†ïÎ¶¨ Ï†ÑÏóêÎäî Ï†êÏàò ÏóÜÏùå
                    checklistHtml,
                    "üí° ÏúÑÏùò Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏Î•º ÌôúÏö©ÌïòÏó¨ Í≥µÍ∞ÑÏùÑ Íπ®ÎÅóÌïòÍ≤å Ï†ïÎ¶¨Ìï¥Î≥¥ÏÑ∏Ïöî!"
                );
            } else if (stage === 'after') {
                const afterLabels = rawLabels;
                const { score, feedback } = calculateScore(beforeLabels, afterLabels);
                analysisStatusMessage.textContent = "‚ú® Ï†ïÎ¶¨ ÌõÑ Î∂ÑÏÑù ÏôÑÎ£å!";
                analyzeBeforeBtn.disabled = false;
                analyzeAfterBtn.disabled = true; // Ï†ïÎ¶¨ ÌõÑÏóêÎäî Îã§Ïãú Ï†ïÎ¶¨ Ï†Ñ Î∂ÑÏÑùÎ∂ÄÌÑ∞ ÏãúÏûëÌïòÎèÑÎ°ù ÎπÑÌôúÏÑ±Ìôî
                resetAppBtn.style.display = 'block'; // 'Îã§Ïãú ÏãúÏûë' Î≤ÑÌäº ÌëúÏãú
                openResultModal(
                    "‚ú® Ï†ïÎ¶¨ ÌõÑ Ï†êÏàò Í≤∞Í≥º",
                    spaceGuess,
                    tips,
                    score,
                    checklistHtml,
                    feedback,
                    true // 'Îã§Ïãú ÏãúÏûë' Î≤ÑÌäº ÌëúÏãú
                );
            }

        } catch (error) {
            console.error("Î∂ÑÏÑù Ï§ë Ïò§Î•ò:", error);
            errorMessage.textContent = `üö® Î∂ÑÏÑù Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ${error.message}`;
            analysisStatusMessage.textContent = "";
            analyzeBeforeBtn.disabled = false;
            analyzeAfterBtn.disabled = beforeLabels.length === 0; // Ï†ïÎ¶¨ Ï†Ñ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ 'Ï†ïÎ¶¨ ÌõÑ' Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
        }
    }

    // Îã§Ïãú ÏãúÏûë Ìï®Ïàò
    function resetApplication() {
        beforeLabels = [];
        beforeSnapshotData = null;
        analyzeBeforeBtn.disabled = false;
        analyzeAfterBtn.disabled = true;
        analyzeBeforeBtn.textContent = "üì∏ ÌòÑÏû¨ Í≥µÍ∞Ñ Î∂ÑÏÑù"; // Î≤ÑÌäº ÌÖçÏä§Ìä∏ Ï¥àÍ∏∞Ìôî
        errorMessage.textContent = "";
        analysisStatusMessage.textContent = "";
        closeResultModal();
        // Ïπ¥Î©îÎùº Ïä§Ìä∏Î¶ºÏùÑ Ïû¨ÏãúÏûëÌï† ÌïÑÏöîÎäî ÏóÜÏßÄÎßå, Î™®Îç∏Ïù¥ Îã§Ïãú Í∞êÏßÄÌïòÎèÑÎ°ù detectLiveObjectsÎ•º Ìò∏Ï∂ú
        detectLiveObjects(); 
    }

    // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
    analyzeBeforeBtn.addEventListener('click', () => analyzeSnapshot('before'));
    analyzeAfterBtn.addEventListener('click', () => analyzeSnapshot('after'));

    // Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ï¥àÍ∏∞Ìôî
    async function initApplication() {
        showScreen("loadingScreen");
        errorMessage.textContent = "";

        try {
            // 1. Î†àÏù¥Î∏î Î°úÎìú (Ï£ºÏã† label.txt ÌååÏùº Í≤ΩÎ°úÎ°ú ÏÑ§Ï†ï)
            customLabels = await loadLabels('./models/yolov8n_oiv7_web_model/label.txt'); 
            if (customLabels.length === 0) {
                throw new Error("Î†àÏù¥Î∏îÏù¥ Î°úÎìúÎêòÏßÄ ÏïäÏïòÏäµÎãàÎã§. label.txt ÌååÏùº Í≤ΩÎ°úÏôÄ ÌòïÏãùÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.");
            }
            console.log(`Custom Labels loaded. Number of labels: ${customLabels.length}`);
            // console.log("Loaded Labels:", customLabels); // ÎîîÎ≤ÑÍπÖÏö©: Î°úÎìúÎêú Î†àÏù¥Î∏î ÌôïÏù∏

            // 2. messyLabelsForScoring ÏÑ§Ï†ï (customLabelsÎ•º Í∏∞Î∞òÏúºÎ°ú ÌïÑÌÑ∞ÎßÅ)
            messyLabelsForScoring = hardcodedMessyLabels.filter(label => customLabels.includes(label));
            console.log(`Messy labels for scoring: ${messyLabelsForScoring.length} labels`);
            // console.log("Messy Labels for Scoring:", messyLabelsForScoring); // ÎîîÎ≤ÑÍπÖÏö©: Ïñ¥ÏßÄÎüΩÌûò Î†àÏù¥Î∏î ÌôïÏù∏


            // 3. Î™®Îç∏ Î°úÎìú
            analysisStatusMessage.textContent = "Î™®Îç∏ Î°úÎìú Ï§ë...";
            yoloModel = await tf.loadGraphModel('./models/yolov8n_oiv7_web_model/model.json'); // ÏÉÅÎåÄ Í≤ΩÎ°ú ÌôïÏù∏
            
            // Î™®Îç∏Ïù¥ Ï≤òÏùå Î°úÎìúÎê† Îïå ÎçîÎØ∏ Ï∂îÎ°†ÏùÑ ÏàòÌñâÌïòÏó¨ ÏõåÎ∞çÏóÖ
            const dummyInput = tf.zeros([1, MODEL_INPUT_SIZE, MODEL_INPUT_SIZE, 3]);
            await yoloModel.executeAsync(dummyInput).dispose();
            dummyInput.dispose();

            analysisStatusMessage.textContent = "Ïπ¥Î©îÎùº Ï¥àÍ∏∞Ìôî Ï§ë...";
            // 4. Ïπ¥Î©îÎùº Ï¥àÍ∏∞Ìôî
            const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 640, height: 480, facingMode: 'environment' } });
            video.srcObject = stream;
            await new Promise(resolve => video.onloadedmetadata = resolve);
            console.log(`Camera initialized. Video dimensions: ${video.videoWidth} ${video.videoHeight}`);

            showScreen("cameraScreen");
            analyzeBeforeBtn.disabled = false;
            analyzeAfterBtn.disabled = true; // 'Ï†ïÎ¶¨ ÌõÑ' Î≤ÑÌäºÏùÄ 'Ï†ïÎ¶¨ Ï†Ñ' Î∂ÑÏÑù ÌõÑÏóê ÌôúÏÑ±Ìôî

            // Ïã§ÏãúÍ∞Ñ Í∞êÏßÄ ÏãúÏûë (ÏõåÎ∞çÏóÖ ÌõÑ)
            detectLiveObjects();

        } catch (error) {
            console.error("Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ï¥àÍ∏∞Ìôî Ïò§Î•ò:", error);
            errorMessage.textContent = `üö® Ïò§Î•ò Î∞úÏÉù: ${error.message}. Ïπ¥Î©îÎùº Ï†ëÍ∑ºÏùÑ ÌóàÏö©ÌïòÍ≥†, Î™®Îç∏ ÌååÏùº Í≤ΩÎ°úÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.`;
            analysisStatusMessage.textContent = "";
            analyzeBeforeBtn.disabled = true; // Ïò§Î•ò Î∞úÏÉù Ïãú Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
        }
    }

    // Î¨∏ÏÑú Î°úÎìú ÏôÑÎ£å Ïãú Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò Ï¥àÍ∏∞Ìôî
    document.addEventListener('DOMContentLoaded', initApplication);
</script>
</body>
</html>